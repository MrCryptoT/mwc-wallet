--- 
steps: 
  - 
    condition: "and(succeeded(), contains(variables['Build.SourceBranch'], 'refs/tags/'), eq(variables['CI_JOB'], 'release' ))"
    displayName: "Cargo Test All"
    script: "cargo test --all"
  - 
    condition: "and(succeeded(), eq( variables['Agent.OS'], 'Linux' ))"
    displayName: "Build Linux Release"
    script: ./build_static_linux.sh
  - 
    condition: "and(succeeded(), eq( variables['Agent.OS'], 'Darwin' ))"
    displayName: "Build MacOS Release"
    script: ./build_static.sh
  - 
    condition: "and(succeeded(), contains(variables['Build.SourceBranch'], 'refs/tags/'), eq(variables['CI_JOB'], 'release' ))"
    displayName: "Create my tag variable"
    script: |
        MY_TAG="$(Build.SourceBranch)"
        MY_TAG=${MY_TAG#refs/tags/}
        echo $MY_TAG
        echo "##vso[task.setvariable variable=build.my_tag]$MY_TAG"
        echo "##vso[task.setvariable variable=build.platform]$PLATFORM"
  - 
    condition: "and(succeeded(), contains(variables['Build.SourceBranch'], 'refs/tags/'), eq(variables['CI_JOB'], 'release' ))"
    displayName: "Copy assets"
    inputs: 
      contents: mwc-wallet
      sourceFolder: $(Build.SourcesDirectory)/target/release
      targetFolder: $(Build.BinariesDirectory)/mwc-wallet
    task: CopyFiles@2
  - 
    condition: "and(succeeded(), contains(variables['Build.SourceBranch'], 'refs/tags/'), eq(variables['CI_JOB'], 'release' ))"
    displayName: "Gather assets"
    inputs: 
      archiveFile: $(Build.ArtifactStagingDirectory)/mwc-wallet-$(build.my_tag)-$(build.platform).tar.gz
      archiveType: tar
      rootFolderOrFile: $(Build.BinariesDirectory)/mwc-wallet
      tarCompression: gz
    task: ArchiveFiles@2
  - 
    condition: "and(succeeded(), contains(variables['Build.SourceBranch'], 'refs/tags/'), eq(variables['CI_JOB'], 'release' ))"
    displayName: "Create Checksum"
    script: "cd $(Build.ArtifactStagingDirectory) && openssl sha256 mwc-wallet-$(build.my_tag)-$(build.platform).tar.gz > mwc-wallet-$(build.my_tag)-$(build.platform)-sha256sum.txt\n"
  - 
    condition: "and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'), eq(variables['CI_JOB'], 'release' ))"
    displayName: "Github release"
    inputs: 
      action: edit
      addChangeLog: true
      assetUploadMode: replace
      assets: |
          $(Build.ArtifactStagingDirectory)/mwc-wallet-$(build.my_tag)-$(build.platform).tar.gz
          $(Build.ArtifactStagingDirectory)/mwc-wallet-$(build.my_tag)-$(build.platform)-sha256sum.txt
      gitHubConnection: github.com_mrcryptot
      repositoryName: mrcryptot/mwc-wallet
      tag: $(build.my_tag)
      tagSource: "Git tag"
      title: $(build.my_tag)
    task: GithubRelease@0
